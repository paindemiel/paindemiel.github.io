---
layout: post
title: Malware Analysis 02 - Behavioral Analysis
category : [MalwareAnalysis]
tags: reverse
---

## Introduction to Dynamic Analysis

Dynamic analysis, also known as behavioral analysis, involves executing malware in a controlled environment to observe its runtime behavior. Unlike static analysis which examines the code without execution, dynamic analysis reveals what the malware actually does when it runs, including network communications, file system changes, registry modifications, and process activities.

This post covers three main approaches to dynamic analysis:
1. **Online Sandboxes** - Cloud-based analysis platforms
2. **Automated Local Sandboxes** - Self-hosted automated analysis systems
3. **Local Lab Analysis** - Manual analysis with monitoring tools

## 1. Online Sandbox Analysis

Online sandboxes provide quick, accessible malware analysis without requiring local infrastructure. They offer comprehensive behavioral analysis with minimal setup.

### Popular Online Sandboxes

#### Any.Run
- **URL**: https://any.run/
- **Features**:
  - Real-time interactive analysis
  - Network traffic visualization
  - Process tree monitoring
  - File system changes tracking
  - Registry modifications
  - Screenshots and video recording
  - API call monitoring
  - YARA rule matching

**Usage Example:**
1. Upload suspicious file to Any.Run
2. Select analysis environment (Windows 7/10, Android, etc.)
3. Monitor real-time behavior
4. Review comprehensive report with:
   - Network connections
   - Process activities
   - File operations
   - Registry changes
   - API calls
   - Threat intelligence

#### Joe Sandbox
- **URL**: https://www.joesandbox.com/
- **Features**:
  - Deep behavioral analysis
  - Machine learning-based detection
  - Multiple analysis environments
  - Detailed technical reports
  - API access for automation
  - Custom analysis profiles

#### Hybrid Analysis
- **URL**: https://www.hybrid-analysis.com/
- **Features**:
  - Crowdsourced threat intelligence
  - Community-driven analysis
  - Integration with multiple AV engines
  - Detailed behavioral reports
  - Sample sharing and collaboration

#### VirusTotal
- **URL**: https://www.virustotal.com/
- **Features**:
  - Multi-engine antivirus scanning
  - Basic behavioral analysis
  - Community comments and analysis
  - File reputation scoring
  - Network behavior analysis

### Advantages of Online Sandboxes
- **No setup required** - Immediate analysis capability
- **Comprehensive tooling** - Professional-grade analysis tools
- **Threat intelligence** - Integration with global threat feeds
- **Scalability** - Handle multiple samples simultaneously
- **Cost-effective** - No infrastructure investment

### Limitations
- **Privacy concerns** - Samples uploaded to third-party services
- **Limited customization** - Fixed analysis environments
- **Network dependency** - Requires internet connectivity
- **Sample size limits** - File size restrictions
- **Analysis time limits** - Limited execution time

## 2. Automated Local Sandbox Analysis

Automated local sandboxes provide full control over the analysis environment while automating the behavioral analysis process.

### CAPEv2 (Cuckoo Advanced Persistent Evaluation)

CAPEv2 is the most popular open-source automated malware analysis platform, offering comprehensive behavioral analysis capabilities.

#### CAPEv2 Architecture

**Core Components:**
- **Cuckoo Core** - Main analysis engine
- **Machinery** - VM management (VirtualBox, VMware, KVM)
- **Analysis Modules** - Behavioral monitoring components
- **Reporting** - Web interface and API
- **Database** - PostgreSQL for storing results

#### Installation and Setup

```bash
# Clone CAPEv2 repository
git clone https://github.com/kevoreilly/CAPEv2.git
cd CAPEv2

# Install dependencies
pip install -r requirements.txt

# Install system dependencies
sudo apt-get install python3-dev python3-pip python3-venv
sudo apt-get install postgresql postgresql-contrib
sudo apt-get install virtualbox virtualbox-ext-pack

# Configure database
sudo -u postgres createuser -P cape
sudo -u postgres createdb -O cape cape
```

#### Configuration

**conf/cuckoo.conf:**
```ini
[database]
connection = postgresql://cape:password@localhost/cape

[resultserver]
ip = 192.168.56.1
port = 2042

[machinery]
module = virtualbox

[processing]
analysisinfo = on
```

**conf/virtualbox.conf:**
```ini
[virtualbox]
mode = gui
path = /usr/bin/VBoxManage
machines = win7_analysis

[win7_analysis]
label = win7_analysis
platform = windows
ip = 192.168.56.101
snapshot = clean_snapshot
```

#### Analysis Modules

CAPEv2 includes numerous analysis modules for comprehensive monitoring:

**Core Modules:**
- **apimon** - API call monitoring
- **processmon** - Process creation and termination
- **filemon** - File system operations
- **regmon** - Registry modifications
- **networkmon** - Network activity
- **screenshots** - Desktop screenshots
- **memory** - Memory dump analysis

**Advanced Modules:**
- **volatility** - Memory forensics
- **yara** - Pattern matching
- **strings** - String extraction
- **peid** - PE file analysis
- **virustotal** - Online reputation check

#### Running Analysis

```bash
# Submit sample for analysis
python3 cuckoo.py --submit /path/to/suspicious.exe

# Submit with custom options
python3 cuckoo.py --submit /path/to/sample.exe --options "timeout=300,memory=on"

# Submit URL for analysis
python3 cuckoo.py --submit-url "http://malicious-site.com/payload.exe"

# Submit with custom package
python3 cuckoo.py --submit /path/to/sample.exe --package exe
```

#### Analysis Results

CAPEv2 generates comprehensive reports including:

**Behavioral Summary:**
- Process tree
- Network connections
- File operations
- Registry changes
- API calls
- Dropped files

**Technical Details:**
- Memory dumps
- Network PCAP files
- Screenshots
- YARA matches
- Antivirus results

**Web Interface:**
- Accessible at `http://localhost:8080`
- Browse analysis results
- Search and filter samples
- Export reports
- API access

### Other Local Sandbox Solutions

#### Cuckoo Sandbox (Original)
- Original version of CAPEv2
- Simpler setup but fewer features
- Good for learning and basic analysis

#### VxStream Sandbox
- Commercial solution
- Advanced evasion detection
- Machine learning analysis
- Cloud and on-premise options

#### FireEye Dynamic Threat Intelligence
- Enterprise-grade solution
- Advanced threat detection
- Integration with security infrastructure

## 3. Local Lab Analysis with Monitoring Tools

Local lab analysis provides the most control and customization options, allowing for detailed manual analysis with specialized monitoring tools.

### Lab Setup Requirements

#### Windows 10 Analysis VM
- **OS**: Windows 10 (preferably 1903 or later)
- **RAM**: 4-8 GB minimum
- **Storage**: 100+ GB
- **Network**: Isolated network segment
- **Tools**: Monitoring and analysis software

#### REMnux VM (Network Analysis)
- **OS**: Ubuntu-based REMnux distribution
- **Purpose**: Network traffic analysis and fake internet simulation
- **Tools**: INetSim, Wireshark, tcpdump, etc.

#### FLARE VM (Automated Lab Setup)
FLARE VM is a Windows-based malware analysis environment that automatically installs and configures numerous analysis tools.

**Features:**
- Automated installation of 100+ analysis tools
- Pre-configured analysis environment
- Integrated toolchain for malware analysis
- Scripts for environment setup and maintenance

**Included Tools:**
- Static analysis: PEiD, CFF Explorer, PE Explorer
- Dynamic analysis: Process Monitor, Process Explorer, API Monitor
- Network analysis: Wireshark, TCPView, Netcat
- Memory analysis: Volatility, WinDbg
- Reverse engineering: IDA Free, x64dbg, Ghidra
- Utilities: 7-Zip, Notepad++, Python, PowerShell

**Installation:**
```powershell
# Clone FLARE VM repository
git clone https://github.com/fireeye/flare-vm.git
cd flare-vm

# Run installation script
.\install.ps1

# Follow prompts for tool selection and configuration
```

**Important Considerations:**
- **Tool Updates**: Many tools may not be up-to-date with latest versions
- **Stability Issues**: Can be buggy and unstable in some environments
- **Maintenance**: Requires regular updates and maintenance
- **Customization**: Limited flexibility for custom tool configurations
- **Resource Usage**: High system requirements due to multiple tools

**Recommendations:**
- Use FLARE VM as a starting point for tool discovery
- Manually install and update critical tools as needed
- Consider building custom analysis environment for production use
- Test thoroughly before using for critical analysis tasks

### Essential Monitoring Tools

#### Process Monitor (ProcMon)
Microsoft's comprehensive system monitoring tool for Windows.

**Key Features:**
- Real-time file system, registry, and process monitoring
- Advanced filtering capabilities
- Detailed event logging
- Process tree visualization

**Usage:**
```cmd
# Start Process Monitor
procmon.exe

# Apply filters for specific processes
# Filter by process name: suspicious.exe
# Filter by operation: CreateFile, RegCreateKey
# Filter by path: C:\Users\*\AppData\*
```

**Common Filters:**
- **Process Name** - Monitor specific executable
- **Operation** - File, registry, or process operations
- **Path** - Specific directories or registry keys
- **Result** - Success/failure of operations
- **Time** - Time-based filtering

#### Process Explorer
Advanced process management and monitoring tool.

**Features:**
- Process tree visualization
- DLL and handle monitoring
- Performance metrics
- Network connections
- Process properties

**Usage:**
```cmd
# Launch Process Explorer
procexp.exe

# Monitor specific process
# Right-click process â†’ Properties
# View handles, DLLs, network connections
```

#### Process Hacker
Open-source alternative to Process Explorer with additional features.

**Advanced Features:**
- Memory scanning
- Network monitoring
- Service management
- Driver monitoring
- Token manipulation

#### API Monitor
Monitor API calls in real-time.

**Usage:**
```cmd
# Launch API Monitor
apimonitor.exe

# Select target process
# Monitor specific APIs:
# - CreateFileW
# - RegCreateKeyExW
# - CreateProcessW
# - InternetConnectW
```

#### Wireshark
Network protocol analyzer for capturing and analyzing network traffic.

**Setup for Malware Analysis:**
```bash
# Capture all traffic on analysis interface
wireshark -i eth0 -k

# Apply display filters
# http.request.method == "POST"
# dns.qry.name contains "malicious"
# tcp.port == 80 or tcp.port == 443
```

**Useful Filters:**
- `http` - HTTP traffic
- `dns` - DNS queries
- `tcp.port == 80` - HTTP traffic
- `tcp.port == 443` - HTTPS traffic
- `ip.addr == 192.168.1.100` - Specific IP

#### TCPView
Monitor TCP and UDP endpoints and their associated processes.

**Features:**
- Real-time connection monitoring
- Process association
- Connection state tracking
- Remote address resolution

#### RegShot
Registry comparison tool for tracking registry changes between snapshots.

**Features:**
- Before/after registry snapshots
- Detailed change reporting
- Export to HTML/XML reports
- Filtering capabilities
- Binary registry value comparison

**Usage:**
```cmd
# Take first snapshot
regshot.exe

# Execute malware sample
C:\samples\suspicious.exe

# Take second snapshot
regshot.exe

# Compare snapshots and generate report
# Review changes in registry keys and values
```

**Common Registry Locations to Monitor:**
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`
- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`
- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run`
- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run`

#### System Informer (formerly Process Hacker)
Advanced system monitoring and analysis tool with comprehensive features.

**Key Features:**
- Process and thread management
- Memory scanning and analysis
- Network connection monitoring
- Service management
- Driver monitoring
- Token manipulation
- File system monitoring
- Registry monitoring
- Performance metrics
- Real-time system information

**Usage:**
```cmd
# Launch System Informer
systeminformer.exe

# Monitor specific processes
# View process properties, handles, memory, network connections
# Analyze services and drivers
# Monitor system performance
```

**Advanced Capabilities:**
- Memory scanning for patterns
- Handle analysis and manipulation
- Service enumeration and management
- Driver loading and unloading
- Token privilege analysis
- File system activity monitoring

### REMnux and INetSim Setup

REMnux provides a comprehensive toolkit for reverse engineering and malware analysis, including INetSim for fake internet simulation.

#### INetSim Configuration

**/etc/inetsim/inetsim.conf:**
```ini
[default]
start_service dns
start_service http
start_service https
start_service ftp
start_service smtp
start_service pop3
start_service irc

[dns]
bind_port = 53
default_ip = 192.168.56.102

[http]
bind_port = 80
default_ip = 192.168.56.102

[https]
bind_port = 443
default_ip = 192.168.56.102
ssl_cert_file = /etc/inetsim/cert.pem
ssl_key_file = /etc/inetsim/key.pem
```

#### Starting INetSim
```bash
# Start INetSim service
sudo inetsim

# Check service status
sudo inetsim --status

# View logs
tail -f /var/log/inetsim/service.log
```

### Analysis Workflow

#### 1. Preparation Phase
```cmd
# Set up monitoring tools
procmon.exe /BackingFile C:\logs\procmon.pml
procexp.exe
systeminformer.exe
wireshark.exe

# Take registry baseline snapshot
regshot.exe

# Configure network settings
# Set DNS to REMnux VM (192.168.56.102)
# Disable Windows Defender
# Create baseline snapshot
```

#### 2. Execution Phase
```cmd
# Execute malware sample
C:\samples\suspicious.exe

# Monitor real-time behavior
# Watch for:
# - New processes
# - File creations
# - Registry changes
# - Network connections
# - API calls
```

#### 3. Analysis Phase
```cmd
# Stop monitoring tools
# Take final registry snapshot
regshot.exe

# Analyze collected data:
# - Process Monitor logs
# - Wireshark captures
# - Process Explorer data
# - System Informer data
# - RegShot comparison report
# - Memory dumps
# - Dropped files
```

#### 4. Documentation
- Document all observed behaviors
- Capture screenshots of interesting activities
- Save network captures and logs
- Note evasion techniques
- Record persistence mechanisms

### Advanced Monitoring Techniques

#### Memory Analysis
```cmd
# Create memory dump
procdump.exe -ma suspicious.exe memory.dmp

# Analyze with Volatility
volatility -f memory.dmp --profile=Win10x64_19041 pslist
volatility -f memory.dmp --profile=Win10x64_19041 netscan
volatility -f memory.dmp --profile=Win10x64_19041 malfind
```

#### Registry Monitoring
```cmd
# Monitor specific registry keys
# HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
# HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
# HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

#### File System Monitoring
```cmd
# Monitor common malware locations
# C:\Users\%USERNAME%\AppData\Local\Temp\
# C:\Users\%USERNAME%\AppData\Roaming\
# C:\Windows\Temp\
# C:\ProgramData\
```

## Best Practices

### General Guidelines
1. **Always use isolated environments** - Never analyze malware on production systems
2. **Document everything** - Keep detailed logs of all analysis activities
3. **Use multiple tools** - Don't rely on a single analysis method
4. **Understand limitations** - Each method has strengths and weaknesses
5. **Stay updated** - Keep tools and analysis environments current

### Security Considerations
1. **Network isolation** - Prevent malware from reaching real networks
2. **Snapshot management** - Use VM snapshots for quick recovery
3. **Data protection** - Secure analysis results and samples
4. **Access control** - Limit access to analysis environments
5. **Incident response** - Have procedures for containment breaches

## Conclusion

Dynamic analysis is essential for understanding malware behavior and capabilities. Each analysis method offers unique advantages:

- **Online sandboxes** provide quick, accessible analysis
- **Automated local sandboxes** offer comprehensive, controlled analysis
- **Manual local analysis** provides maximum control and customization

Successful malware analysis often requires combining multiple approaches to build a complete picture of malware behavior. Understanding the strengths and limitations of each method helps analysts choose the most appropriate tools for their specific needs.

## Tools and Resources

### Online Sandboxes
- [Any.Run](https://any.run/)
- [Joe Sandbox](https://www.joesandbox.com/)
- [Hybrid Analysis](https://www.hybrid-analysis.com/)
- [VirusTotal](https://www.virustotal.com/)

### Local Sandbox Solutions
- [CAPEv2](https://github.com/kevoreilly/CAPEv2)
- [Cuckoo Sandbox](https://cuckoosandbox.org/)
- [REMnux](https://remnux.org/)

### Monitoring Tools
- [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon)
- [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer)
- [System Informer](https://github.com/winsiderss/systeminformer)
- API Monitor -> http://www.rohitab.com/apimonitor
- [Wireshark](https://www.wireshark.org/)
- [TCPView](https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview)
- [RegShot](https://sourceforge.net/projects/regshot/)

### Analysis Environments
- [FLARE VM](https://github.com/fireeye/flare-vm)
- [REMnux](https://remnux.org/)

### Additional Resources
- [Malware Analysis Training](https://www.malware-traffic-analysis.net/)
- [SANS Malware Analysis](https://www.sans.org/cyber-security-courses/malware-analysis-essentials/)
- [Practical Malware Analysis](https://nostarch.com/malware)

