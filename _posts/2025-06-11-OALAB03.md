---
layout: post
title: 3 OALAB After Analysis
category : [Reverse, OALAB]
tags: reverse
---

# Theory

## Goal 

- For everyone
- What's the malware trying to achieve

## Capabilities

- for other reverse engineers
- How is the malware going to achieve its goal
- List main functions
- Language
- Packed / UnPacked / Obfuscated
- Persistence
- C2
- Special Capabitlities 
- etc ...

## IOCs (Indicators of Compromise)

- for soc analyst 
- Rules:
  - Sigma
  - YARA
- Behavior:
  - Hash
  - Ip / Domain 
  - Strings 
  - etc ...

# a report could be 
```markdown
Goal

The goal of the malware is to terminate a list of hard coded processes and delete their executables from the host. The processes are associated with Windows Defender, and TrendMicro anti-virus products.

Behaviour

The malware is deployed in two stages. The first stage is a dropper that contains two embedded payloads, one built for 32-bit hosts and one for 64-bit.

The dropper a DLL with a single export “Work”. The DLL has been compiled using MSVC and is written in C. 

When executed, the “Work” function checks the host for running processes spawned by either “MsMpEng.exe” or “coreFrameworkHost.exe”. 

If a matching process is detected the dropper writes the to the %TEMP% directory using a generated file name. The generated file name is prefixed with “Upd” and ends with “_FlashPlayer.exe”, for example, “Updxxxxx_FlashPlayer.exe”. 

The dropped payload is then executed via the shell command “open”.

The 32-bit payload is an EXE that has been compiled using MSVC and is written in C. 

When executed the payload adjusts it’s process token to enable “SeDebugPrivilege”. If the token adjustment fails the payload terminates.

After “SeDebugPrivilege” has been enabled the payload searches for processes spawned from the following executables. 

coreFrameworkHost.exe
coreServiceShell.exe
uiSeAgnt.exe
uiWatchDog.exe

These processes are associated with TrendMicro anti-virus.

MsMpEng.exe
msseces.exe

These processes are associated with Windows Defender.

If a processes matches the search it is terminated and its executable is deleted from the host. 

To terminate a process the payload uses “QueueUserAPC” to call the “ExitProcess” function from each thread in the process.

To delete the process executable from the host the payload uses two methods. First it opens a handle to the file via the local network path C$ share “\\127.0.0.1\c$” then uses “SetFileInformationByHandle” with “FileDispositionInfo” to set the file for deletion. Next it uses the NTDLL function ZwDeleteFile to delete the file.

If the executable deletion is completed successfully then the malware sends a message back to its command and control server in a POST request. The format of the post request is as follows.

id=<id_string>data=<data_string>

The data_string is generated by combining the host major version, minor version, and build number with a hard coded string in the binary. If the deleted executable is associate with TrendMicro then the string is Vtgpfoketq”mknngf, hard coded in the binary with a simple add one encryption routine. If the deleted executable is associated with Windows Defender then the string is OUG, hard coded with the same simple add one encryption routine. 

While the decryption routine in the binary yields an unintelligible string, if a subtract one decryption scheme is used instead, the strings produced are “Trendmicro killed” and, “MSE”. The malware developer has likely made a mistake when implementing the decryption, adding instead of subtracting one.

The data string is then base64 encoded and URL encoded. An example of the pre encoded and post encoded data_string is shown below.

6.2.9200 Vtgpfoketq"mknngf

Ni4yLjkyMDAgVnRncGZva2V0cSJta25uZ2Y%3D%0D%0A

The id_string is generated by combining the user SID, install date, and user name, and generating an MD5 hash of the resulting string. The MD5 hash is then hex encoded and base64 encoded.

The URL path for the POST request is generated by RC4 encrypting the string “mod=info”. The key used for the RC4 encryption is the first 8 bytes of the hex encoded MD5 hash used to generate the id_string. The RC4 output is hex encoded and prepended with the 8 byte key to form the final URL.

id_string
0431AF1E403FDC1032E3CE9496F8DDE0

key
04 31 AF 1E

RC4("mod=info", "0431AF1E")
C0 56 91 93 51 F1 16 65

path
/0431AF1EC056919351F11665

The User Agent for the POST request is also hardcoded in the binary.

Four IP address and Port numbers are hard coded in the binary and used for the C2 request via a random selection algorithm. The payload attempts to connect to the C2 ten times, each time randomly choosing one of the four IP address and Port pairs.

The payload does not receive any commands from the C2 and simply terminates upon successfully sending the POST request and receiving more than a single byte of data in response.

At the time of writing this report only the dropper and the 32-bit payload have been analyzed. 

IOCs

Stage1
93f9703cc7339014cd1bc82da0ab8909957112b93fba2430b5ee90a1d424a5ed

Stage2 - 32-bit
7b5b060d9013725413f3f77719d0881035246b281e18005c0040e78a32e1c6cc

Stage2 - 64-bit
000c96c78dfed72fc84abac73fe19c63b0a0974a94377f50eda66ff419b6b752

Notable Strings - 7b5b060d9013725413f3f77719d0881035246b281e18005c0040e78a32e1c6cc
id=%s&data=
mod=info
Usfoenjdsp!ljmmfe
NTF
coreFrameworkHost.exe
coreServiceShell.exe
uiSeAgnt.exe
uiWatchDog.exe
MsMpEng.exe
msseces.exe

Dropped Files
%TEMP%\Updxxxxx_FlashPlayer.exe (xxxxx - random number)

C2s
187.33.1.171:8080
91.121.16.24:8080
198.101.241.159:8080
91.121.55.127:8080
```