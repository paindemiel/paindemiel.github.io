---
layout: post
title: 4 MALDEV - Privilege Escalation
category : [Reverse, MALDEV]
tags: reverse
---

# Access Tokens


## Windows Tokens 

After successful authentication of user, [Local Security Authority](https://learn.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication) will proceed to generate a new login session and an access token.

![token](assets\images\maldev\4\token.png)

Each instance of logging into system is characterized by 64-bit **Locally unique identifier (LUID)** commonly referred as the **Logon ID**, moreover every access token must contain an **Authentication ID (AuthId)** parameter, which serves to identify the associated login session by utilizing this LUID.

Main objective of access token is to function as a *transient repository for security configurations* associated with logon session, which can be modified in real time. In the context described, Windows developers engage with the access token that serves as a representation of the logon session, residing with the *lsass* process.

It's possible for developer to copy pre-existing tokens using the **DuplicateTokenEx** function :

```c 
BOOL DuplicateTokenEx(
HANDLE                       hExistingToken,
DWORD                        dwDesiredAccess,
LPSECURITY_ATTRIBUTES        lpTokenAttributes,
SECURITY_IMPERSONATION_LEVEL ImpersonationLevel,
TOKEN_TYPE                   TokenType,
PHANDLE                      phNewToken
);
```

The calling thread has capability to assume the security context of user who is currently logged in, achieved through use of **ImpersonateLoggedOnPerson** function :

```c 
BOOL ImpersonateLoggedOnUser(
  HANDLE hToken
);
```

Token also includes a login **security identifier (SID)**, which serves to identify the ongoing logon session.

Rights of a user account dictate the specific system actions that can be performed by said account.
Assignement of user and group rights is carried by administrator. Rights of each user encompass entitlements granted to both individual user and many groups to which user is affiliated.

The access token routines employ the LUID type to identify and manipulate privileges.
**LookupPrivilegeValue** function can be utilized to ascertain locally assigned LUID for a privilege constant :

```c 
BOOL LookupPrivilegeValueA(
  LPCSTR  lpSystemName,
  LPCSTR  lpName,
  PLUID   lpLuid
);
```

The information can be access with following powershell command `whoami /all` or `whoami /priv` :

![priv](assets\images\maldev\4\whoami.png)

It could also be accessed with `Process Explorer`.

![priv](assets\images\maldev\4\processexplorer.png)

There are two types of access token :
1. Primary (or sometimes delegate)
2. Impersonation

Upon user's login to Windows domain, primary tokens are generated, task can be achieved either by physically gaining access to a Windows machine or remotely connecting to it via Remote Desktop.

Impersonation tokens typically operate inside distinct security context from procedure that began their creation. Non-interactive tokens are employed for the purpose of mounting network shares or executing domain logon routines.

# Password stealing

# Leveraging DLL search order hijacking and supply chain attacks

# Circumventing UAC 

